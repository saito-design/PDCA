# 引継ぎファイル - 2026-02-19

## 基本ルール
`C:/Users/yasuh/OneDrive/デスクトップ/APP/CLAUDE.md` を参照

## プロジェクト
PDCA Dashboard (`C:/Users/yasuh/OneDrive/デスクトップ/APP/PDCA`)

## 完了した作業

### 1. 部署ごとのJSON分離
- 企業フォルダ直下の一括JSONから、部署フォルダごとのtasks.json/cycles.jsonに変更
- データ移行完了（鳥取・鹿児島）

### 2. 自動フォルダID検索機能
- `src/lib/entity-helpers.ts` を作成
- entities.jsonにdrive_folder_idがなくても、フォルダ名で自動検索
- 見つかったらentities.jsonを自動更新

### 3. 対象APIの更新
以下のAPIを共有ヘルパー（entity-helpers.ts）に統一:
- `/api/clients/[clientId]/entities/[entityId]/tasks`
- `/api/clients/[clientId]/entities/[entityId]/tasks/[taskId]`
- `/api/clients/[clientId]/entities/[entityId]/cycles`
- `/api/clients/[clientId]/entities/[entityId]/pdca/tasks/[taskId]/cycles`

## 未完了・次にやること

### 1. まとめJSON機能（パフォーマンス最適化）
**目的:** 全体ビュー/レポーティングの高速化

**現状の問題:**
- 全体ビューやレポートで部署数分のファイルを読み込む
- 部署が増えると遅くなる

**提案された解決策:**
```
企業フォルダ/
├── all-tasks.json      ← 全部署のタスクを集約（新規）
├── all-cycles.json     ← 全部署のサイクルを集約（新規）
├── entities.json
├── 全体/
│   ├── tasks.json
│   └── cycles.json
└── ...
```

**実装方針:**
1. タスク/サイクルの追加・更新・削除時に、まとめjsonも同時更新
2. 全体ビュー/レポートAPIはまとめjsonを読み込む
3. 整合性のためのリビルド機能（手動/定期）も検討

**対象ファイル:**
- `src/app/api/clients/[clientId]/entities/[entityId]/tasks/route.ts` (POST)
- `src/app/api/clients/[clientId]/entities/[entityId]/tasks/[taskId]/route.ts` (PATCH/DELETE)
- `src/app/api/clients/[clientId]/entities/[entityId]/pdca/tasks/[taskId]/cycles/route.ts` (POST/PATCH)
- 全体ビュー/レポート用のAPI（まとめjson読み込みに変更）

### 2. 部署並び替え問題（要調査）
- ユーザー報告: 部署を並び替えてもリロードで戻る
- PATCH APIは実装済みだが、保存されていない可能性
- ブラウザの開発者ツールでネットワーク確認が必要

## 重要な決定事項
- DBは使わない（Google Drive + JSON）
- 部署ごとにtasks.json/cycles.jsonを分離
- drive_folder_idがなくてもフォルダ名で自動検索

## 注意点
- 鳥取の「全体」「経営企画」は元々データなし（消えたわけではない）
- ユーザーが追加したデータが移行前に存在していなかった可能性

## Google Driveフォルダ構造
```
G:/共有ドライブ/PDCA/
├── clients.json
├── 鳥取県市町村職員共済組合/
│   ├── entities.json
│   ├── 全体/tasks.json, cycles.json
│   ├── 経営企画/tasks.json, cycles.json
│   ├── 料理/tasks.json, cycles.json
│   ├── 宿泊企画/tasks.json, cycles.json
│   └── サービス/tasks.json, cycles.json
└── 鹿児島県市町村職員共済組合/
    └── （同様の構造）
```
